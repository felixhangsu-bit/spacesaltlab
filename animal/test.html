<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åŠ¨ç‰©æŠ•å°„æµ‹è¯• | å®‡å®™è®¤çŸ¥ç›ç©¶æ‰€</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --primary: #f59e0b;
  --primary-dark: #d97706;
  --primary-light: #fcd34d;
  --gradient: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
  --bg: #f8fafc;
  --card: #ffffff;
  --text: #1e293b;
  --text-muted: #64748b;
  --border: #e2e8f0;
  --shadow: 0 4px 20px rgba(0,0,0,0.08);
  --radius: 16px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans SC', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
.page { display: none; min-height: 100vh; }
.page.active { display: block; }

/* æµ‹è¯•é¡µ */
#testPage { background: var(--bg); padding: 20px; }
.test-container { max-width: 700px; margin: 0 auto; }
.test-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.back-btn { display: flex; align-items: center; gap: 6px; background: none; border: none; color: var(--text-muted); font-size: 14px; cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; }
.back-btn:hover { background: white; color: var(--text); }
.progress-wrap { text-align: right; }
.progress-text { font-size: 13px; color: var(--text-muted); margin-bottom: 6px; }
.progress-bar { width: 180px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--gradient); border-radius: 3px; transition: width 0.3s; }
.question-card { background: var(--card); border-radius: var(--radius); padding: 40px; box-shadow: var(--shadow); }
.q-num { font-size: 13px; color: var(--text-muted); margin-bottom: 10px; }
.q-text { font-size: 20px; font-weight: 600; line-height: 1.5; margin-bottom: 32px; }
.options { display: flex; flex-direction: column; gap: 12px; }
.opt { display: flex; align-items: center; gap: 14px; padding: 16px 20px; border: 2px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
.opt:hover { border-color: var(--primary-light); background: #fffbeb; }
.opt.selected { border-color: var(--primary); background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
.opt-radio { width: 22px; height: 22px; border: 2px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
.opt.selected .opt-radio { border-color: var(--primary); background: var(--primary); }
.opt.selected .opt-radio::after { content: ''; width: 8px; height: 8px; background: white; border-radius: 50%; }
.opt-text { font-size: 15px; font-weight: 500; }
.nav-btns { display: flex; gap: 12px; margin-top: 32px; }
.nav-btn { flex: 1; padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; }
.nav-btn.secondary { background: white; border: 2px solid var(--border); color: var(--text); }
.nav-btn.secondary:hover { border-color: var(--primary-light); }
.nav-btn.primary { background: var(--gradient); border: none; color: white; }
.nav-btn.primary:hover { opacity: 0.9; }
.nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* ç»“æœé¡µ */
#resultPage { background: #f8fafc; }
.result-container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
.result-header { text-align: center; margin-bottom: 40px; }
.result-logo { font-size: 64px; margin-bottom: 16px; }
.result-title { font-size: 28px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
.result-subtitle { color: var(--text-muted); font-size: 15px; }
.card { background: #fff; border-radius: 20px; padding: 32px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
.section-title { display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--text); }
.section-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }

/* åŠ¨ç‰©äººæ ¼å¡ç‰‡ */
.animal-main { display: flex; gap: 24px; align-items: center; padding: 24px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; margin-bottom: 20px; }
.animal-icon { font-size: 72px; }
.animal-info h3 { font-size: 24px; color: #92400e; margin-bottom: 8px; }
.animal-info .subtitle { font-size: 14px; color: #b45309; margin-bottom: 12px; }
.animal-info p { font-size: 14px; color: #78350f; line-height: 1.6; }

.animal-secondary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px; }
.animal-card { padding: 20px; background: #f8fafc; border-radius: 12px; text-align: center; }
.animal-card .icon { font-size: 40px; margin-bottom: 8px; }
.animal-card .name { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.animal-card .context { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
.animal-card .desc { font-size: 13px; color: var(--text-muted); line-height: 1.5; }

/* æƒ…å¢ƒåˆ†æ */
.situation-analysis { margin-top: 20px; }
.situation-item { padding: 20px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px; }
.situation-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.situation-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
.situation-name { font-weight: 600; color: var(--text); }
.situation-animal { font-size: 13px; color: var(--primary); }
.situation-desc { font-size: 14px; color: var(--text-muted); line-height: 1.6; }

/* åˆ‡æ¢æ¨¡å¼åˆ†æ */
.switch-analysis { padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fff7ed 100%); border-radius: 12px; margin-top: 20px; }
.switch-title { font-weight: 600; color: #92400e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.switch-content { font-size: 14px; color: #78350f; line-height: 1.7; }

/* å»ºè®® */
.tip-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid #f1f5f9; }
.tip-item:last-child { border-bottom: none; }
.tip-num { width: 28px; height: 28px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 14px; font-weight: 600; flex-shrink: 0; }
.tip-text { font-size: 14px; color: var(--text-muted); line-height: 1.6; }

/* æŒ‰é’® */
.action-buttons { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 32px; }
.action-btn { flex: 1; min-width: 140px; padding: 16px 24px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
.action-btn.primary { background: var(--gradient); border: none; color: #fff; }
.action-btn.secondary { background: #fff; border: 2px solid var(--border); color: var(--text); }
.restart-btn { background: #fff; border: 2px solid var(--border); color: var(--text); padding: 16px 24px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; }

/* å¼¹çª— */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
.modal-overlay.show { opacity: 1; visibility: visible; }
.modal-content { background: #fff; border-radius: 24px; padding: 40px; max-width: 400px; text-align: center; }
.modal-icon { font-size: 48px; margin-bottom: 16px; }
.modal-content h3 { font-size: 20px; margin-bottom: 12px; }
.modal-content p { color: var(--text-muted); margin-bottom: 24px; }
.modal-btn { padding: 14px 32px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; }
.modal-btn.primary { background: var(--gradient); border: none; color: #fff; }

/* loading */
.loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
.loading-overlay.show { opacity: 1; visibility: visible; }
.loading-spinner { width: 48px; height: 48px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

@media (max-width: 640px) {
  .animal-main { flex-direction: column; text-align: center; }
  .action-buttons { flex-direction: column; }
}
</style>
</head>
<body>

<div id="testPage" class="page active">
  <div class="test-container">
    <div class="test-header">
      <button class="back-btn" onclick="if(confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ'))location.href='index.html'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        è¿”å›
      </button>
      <div class="progress-wrap">
        <div class="progress-text"><span id="current">1</span> / 16</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:6.25%"></div></div>
      </div>
    </div>
    <div class="question-card">
      <div class="q-num">ç¬¬ <span id="qNum">1</span> é¢˜</div>
      <div class="q-text" id="questionText"></div>
      <div class="options" id="optionsContainer"></div>
      <div class="nav-btns">
        <button class="nav-btn secondary" id="prevBtn" onclick="prev()" disabled>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
          ä¸Šä¸€é¢˜
        </button>
        <button class="nav-btn primary" id="nextBtn" onclick="next()" disabled>
          ä¸‹ä¸€é¢˜
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<div id="resultPage" class="page">
  <div class="result-container" id="resultContent"></div>
</div>

<div class="loading-overlay" id="loading">
  <div class="loading-spinner"></div>
  <p style="margin-top:16px;color:var(--text-muted)">æ­£åœ¨ç”ŸæˆPDFæŠ¥å‘Š...</p>
</div>

<script>
const questions = [
  // æ”¾æ¾å®‰å…¨æ—¶ (4é¢˜)
  { q: "å‘¨æœ«ç‹¬å¤„æ—¶ï¼Œä½ æœ€å¯èƒ½åœ¨åšä»€ä¹ˆï¼Ÿ", situation: "relax", options: [
    { text: "çªåœ¨è§’è½çœ‹ä¹¦æˆ–åˆ·å‰§ï¼Œäº«å—ä¸è¢«æ‰“æ‰°", animals: ["cat", "owl"] },
    { text: "çº¦æœ‹å‹å‡ºå»ç©ï¼Œæˆ–è€…åœ¨å®¶ä¹Ÿè¦å¼€ç€è§†é¢‘èŠå¤©", animals: ["dog", "dolphin"] },
    { text: "ç ”ç©¶ä¸€ä¸ªæ„Ÿå…´è¶£çš„è¯é¢˜ï¼Œæ·±åº¦æ¢ç´¢", animals: ["owl", "fox"] },
    { text: "åšç‚¹åˆ›æ„çš„äº‹ï¼Œæ¯”å¦‚ç”»ç”»ã€å†™ä¸œè¥¿ã€æ•´ç†æˆ¿é—´", animals: ["fox", "deer"] }
  ]},
  { q: "åœ¨ä¸€ä¸ªè®©ä½ å®Œå…¨æ”¾æ¾çš„ç¯å¢ƒé‡Œï¼Œä½ ä¼šå±•ç°å‡ºä»€ä¹ˆæ ·çš„çŠ¶æ€ï¼Ÿ", situation: "relax", options: [
    { text: "å®‰é™ã€æ…µæ‡’ï¼Œäº«å—ç‹¬å¤„çš„è‡ªåœ¨", animals: ["cat", "owl"] },
    { text: "æ´»è·ƒã€è¯å¤šï¼Œå–œæ¬¢å’Œäººäº’åŠ¨", animals: ["dog", "dolphin"] },
    { text: "å¥½å¥‡ã€æ¢ç´¢ï¼Œå¯¹æ–°äº‹ç‰©å……æ»¡å…´è¶£", animals: ["fox", "owl"] },
    { text: "æ¸©å’Œã€åŒ…å®¹ï¼Œç…§é¡¾å‘¨å›´äººçš„æ„Ÿå—", animals: ["deer", "dolphin"] }
  ]},
  { q: "å½“ä½ æ„Ÿåˆ°å®‰å…¨å’Œè¢«æ¥çº³æ—¶ï¼Œä½ æœ€å®¹æ˜“æµéœ²å‡ºçš„ç‰¹è´¨æ˜¯ï¼Ÿ", situation: "relax", options: [
    { text: "ç‹¬ç«‹ä¸”æœ‰è¾¹ç•Œæ„Ÿ", animals: ["cat", "wolf"] },
    { text: "çƒ­æƒ…ä¸”ä¹äºåˆ†äº«", animals: ["dog", "dolphin"] },
    { text: "æ•é”ä¸”æœ‰æ´å¯ŸåŠ›", animals: ["fox", "owl"] },
    { text: "æŸ”è½¯ä¸”å®¹æ˜“ä¿¡ä»»ä»–äºº", animals: ["deer", "dog"] }
  ]},
  { q: "åœ¨æœ€èˆ’é€‚çš„çŠ¶æ€ä¸‹ï¼Œä½ å¯¹å¾…æ—¶é—´çš„æ€åº¦æ˜¯ï¼Ÿ", situation: "relax", options: [
    { text: "æŒ‰è‡ªå·±çš„èŠ‚å¥æ¥ï¼Œä¸è¢«æ‰“æ‰°æœ€é‡è¦", animals: ["cat", "owl"] },
    { text: "å’Œå–œæ¬¢çš„äººåœ¨ä¸€èµ·ï¼Œæ€æ ·éƒ½å¼€å¿ƒ", animals: ["dog", "dolphin"] },
    { text: "åšæœ‰æ„ä¹‰çš„äº‹ï¼Œä¸æƒ³æµªè´¹æ—¶é—´", animals: ["fox", "wolf"] },
    { text: "éšé‡è€Œå®‰ï¼Œäº«å—å½“ä¸‹å°±å¥½", animals: ["deer", "dolphin"] }
  ]},

  // äº²å¯†å…³ç³»ä¸­ (4é¢˜)
  { q: "åœ¨äº²å¯†å…³ç³»ä¸­ï¼Œä½ æœ€åœ¨æ„çš„æ˜¯ä»€ä¹ˆï¼Ÿ", situation: "intimate", options: [
    { text: "è¢«å°Šé‡ä¸ªäººç©ºé—´å’Œç‹¬ç«‹æ€§", animals: ["cat", "wolf"] },
    { text: "è¢«éœ€è¦ã€è¢«ä¾èµ–çš„æ„Ÿè§‰", animals: ["dog", "bear"] },
    { text: "ç²¾ç¥ä¸Šçš„å¥‘åˆå’Œç†è§£", animals: ["owl", "fox"] },
    { text: "æƒ…æ„Ÿçš„ç¨³å®šå’Œå®‰å…¨æ„Ÿ", animals: ["deer", "dolphin"] }
  ]},
  { q: "å½“ä¼´ä¾£æƒ…ç»ªä½è½æ—¶ï¼Œä½ é€šå¸¸ä¼šï¼Ÿ", situation: "intimate", options: [
    { text: "ç»™taç©ºé—´ï¼Œç­‰taå‡†å¤‡å¥½äº†å†è¯´", animals: ["cat", "owl"] },
    { text: "ä¸»åŠ¨é è¿‘ï¼Œé™ªä¼´å’Œå®‰æ…°", animals: ["dog", "bear"] },
    { text: "åˆ†æé—®é¢˜ï¼Œå¸®taæƒ³è§£å†³åŠæ³•", animals: ["fox", "owl"] },
    { text: "æ„ŸåŒèº«å—ï¼Œå®¹æ˜“è¢«taçš„æƒ…ç»ªå½±å“", animals: ["deer", "dolphin"] }
  ]},
  { q: "åœ¨çˆ±æƒ…é‡Œï¼Œä½ æ›´åƒå“ªç§çŠ¶æ€ï¼Ÿ", situation: "intimate", options: [
    { text: "ä¿æŒç¥ç§˜æ„Ÿï¼Œä¸ä¼šå®Œå…¨æ•å¼€", animals: ["cat", "fox"] },
    { text: "å…¨èº«å¿ƒæŠ•å…¥ï¼Œæ¨ä¸å¾—é»åœ¨ä¸€èµ·", animals: ["dog", "bear"] },
    { text: "ç†æ€§è§‚å¯Ÿï¼ŒåŒæ—¶ä¿æŒè‡ªæˆ‘", animals: ["owl", "wolf"] },
    { text: "ä»˜å‡ºå‹ï¼Œæ€»æƒ³ç€å¯¹æ–¹çš„éœ€æ±‚", animals: ["deer", "dolphin"] }
  ]},
  { q: "å¦‚æœæ„Ÿæƒ…å‡ºç°å±æœºï¼Œä½ çš„ç¬¬ä¸€ååº”æ˜¯ï¼Ÿ", situation: "intimate", options: [
    { text: "åé€€ä¸€æ­¥ï¼Œéœ€è¦æ—¶é—´æ€è€ƒ", animals: ["cat", "owl"] },
    { text: "æ›´åŠ åŠªåŠ›æŒ½å›ï¼Œå®³æ€•å¤±å»", animals: ["dog", "deer"] },
    { text: "å†·é™åˆ†æåŸå› ï¼Œæ‰¾è§£å†³æ–¹æ¡ˆ", animals: ["fox", "owl"] },
    { text: "æ„Ÿåˆ°å—ä¼¤ï¼Œä½†è¿˜æ˜¯æƒ³åŒ…å®¹å¯¹æ–¹", animals: ["deer", "dolphin"] }
  ]},

  // å†²çªå‹åŠ›ä¸‹ (4é¢˜)
  { q: "é¢å¯¹æ¿€çƒˆçš„äº‰åµï¼Œä½ çš„åº”æ¿€ååº”æ˜¯ï¼Ÿ", situation: "conflict", options: [
    { text: "å†·æ¼ å›é¿ï¼Œä¸æƒ³çº ç¼ ", animals: ["cat", "owl"] },
    { text: "æ®ç†åŠ›äº‰ï¼Œä¸èƒ½è¢«è¯¯è§£", animals: ["wolf", "bear"] },
    { text: "å†·é™è§‚å¯Ÿï¼Œå¯»æ‰¾å¼±ç‚¹æˆ–å‡ºè·¯", animals: ["fox", "owl"] },
    { text: "å§”å±ˆé€€è®©ï¼Œåªæƒ³ç»“æŸå†²çª", animals: ["deer", "dolphin"] }
  ]},
  { q: "å½“ä½ æ„Ÿåˆ°è¢«æ”»å‡»æˆ–ä¸å…¬å¹³å¯¹å¾…æ—¶ï¼Œä½ ä¼šï¼Ÿ", situation: "conflict", options: [
    { text: "è¡¨é¢å†·é™ï¼Œå†…å¿ƒå·²ç»åœ¨åˆ’æ¸…ç•Œé™", animals: ["cat", "wolf"] },
    { text: "ç›´æ¥åå‡»ï¼Œä¿æŠ¤è‡ªå·±çš„ç«‹åœº", animals: ["wolf", "bear"] },
    { text: "ç­–ç•¥æ€§åº”å¯¹ï¼Œä¸æ­£é¢ç¡¬åˆš", animals: ["fox", "owl"] },
    { text: "æ„Ÿåˆ°å—ä¼¤ï¼Œå¯èƒ½ä¼šå“­æˆ–æ²‰é»˜", animals: ["deer", "dolphin"] }
  ]},
  { q: "åœ¨é«˜å‹ç¯å¢ƒä¸‹ï¼Œä½ æœ€å¯èƒ½å‡ºç°çš„çŠ¶æ€æ˜¯ï¼Ÿ", situation: "conflict", options: [
    { text: "åˆ‡æ–­æƒ…ç»ªï¼Œå˜å¾—å†·æ¼ é«˜æ•ˆ", animals: ["cat", "owl"] },
    { text: "ç„¦èºæ˜“æ€’ï¼Œæˆ˜æ–—åŠ›çˆ†æ£š", animals: ["wolf", "bear"] },
    { text: "é«˜åº¦è­¦è§‰ï¼Œéšæ—¶å‡†å¤‡åº”å˜", animals: ["fox", "wolf"] },
    { text: "ç´§å¼ ç„¦è™‘ï¼Œæƒ³è¦é€ƒé¿æˆ–æ±‚åŠ©", animals: ["deer", "dolphin"] }
  ]},
  { q: "å†²çªè¿‡åï¼Œä½ éœ€è¦å¤šä¹…æ‰èƒ½æ¢å¤ï¼Ÿ", situation: "conflict", options: [
    { text: "å¾ˆå¿«ï¼Œæˆ‘ä¼šè¿…é€Ÿåˆ‡å‰²æƒ…ç»ª", animals: ["cat", "fox"] },
    { text: "å–å†³äºè¾“èµ¢ï¼Œèµ¢äº†å°±æ²¡äº‹", animals: ["wolf", "bear"] },
    { text: "ä¼šå¤ç›˜åˆ†æï¼Œç¡®ä¿ä¸‹æ¬¡æ›´å¥½åº”å¯¹", animals: ["fox", "owl"] },
    { text: "éœ€è¦å¾ˆä¹…ï¼Œä¼šåå¤å›æƒ³å—ä¼¤çš„æ„Ÿè§‰", animals: ["deer", "dolphin"] }
  ]},

  // è¢«éœ€è¦/è¢«æœŸå¾…æ—¶ (4é¢˜)
  { q: "å½“åˆ«äººå¯¹ä½ æŠ±æœ‰å¾ˆé«˜æœŸå¾…æ—¶ï¼Œä½ ä¼šï¼Ÿ", situation: "expected", options: [
    { text: "æ„Ÿåˆ°å‹åŠ›ï¼Œæƒ³è¦åˆ’æ¸…è¾¹ç•Œ", animals: ["cat", "wolf"] },
    { text: "æ„Ÿåˆ°è¢«é‡è§†ï¼Œæ›´æœ‰åŠ¨åŠ›", animals: ["dog", "bear"] },
    { text: "è¯„ä¼°æ˜¯å¦åˆç†ï¼Œå†å†³å®šå¦‚ä½•å›åº”", animals: ["fox", "owl"] },
    { text: "å°½åŠ›æ»¡è¶³ï¼Œæ€•è®©äººå¤±æœ›", animals: ["deer", "dolphin"] }
  ]},
  { q: "æœ‰äººå‘ä½ æ±‚åŠ©æ—¶ï¼Œä½ çš„å†…å¿ƒæ´»åŠ¨æ˜¯ï¼Ÿ", situation: "expected", options: [
    { text: "çœ‹æƒ…å†µï¼Œä¸æ˜¯æ‰€æœ‰å¿™éƒ½è¦å¸®", animals: ["cat", "fox"] },
    { text: "å¾ˆå¼€å¿ƒè¢«éœ€è¦ï¼Œä¼šå°½åŠ›å¸®å¿™", animals: ["dog", "bear"] },
    { text: "åˆ†æé—®é¢˜ï¼Œç»™å‡ºæœ‰æ•ˆå»ºè®®", animals: ["owl", "fox"] },
    { text: "å¾ˆéš¾æ‹’ç»ï¼Œå³ä½¿è‡ªå·±å¾ˆç´¯", animals: ["deer", "dolphin"] }
  ]},
  { q: "åœ¨å›¢é˜Ÿä¸­ï¼Œä½ é€šå¸¸æ‰®æ¼”ä»€ä¹ˆè§’è‰²ï¼Ÿ", situation: "expected", options: [
    { text: "ç‹¬ç«‹å®Œæˆè‡ªå·±çš„éƒ¨åˆ†ï¼Œä¸å¤ªå¹²æ¶‰åˆ«äºº", animals: ["cat", "owl"] },
    { text: "æ ¸å¿ƒäººç‰©ï¼Œå¤§å®¶éƒ½æ„¿æ„è·Ÿç€æˆ‘", animals: ["wolf", "bear"] },
    { text: "å†›å¸ˆå‹ï¼Œå‡ºè°‹åˆ’ç­–", animals: ["fox", "owl"] },
    { text: "åè°ƒè€…ï¼Œç…§é¡¾æ¯ä¸ªäººçš„æ„Ÿå—", animals: ["deer", "dolphin"] }
  ]},
  { q: "å½“ä½ å¸®åŠ©åˆ«äººåï¼Œä½ æœŸå¾…ä»€ä¹ˆï¼Ÿ", situation: "expected", options: [
    { text: "ä¸æœŸå¾…å›æŠ¥ï¼Œä½†å¸Œæœ›è¢«å°Šé‡è¾¹ç•Œ", animals: ["cat", "wolf"] },
    { text: "å¸Œæœ›å¯¹æ–¹è®°å¾—è¿™ä»½æƒ…è°Š", animals: ["dog", "bear"] },
    { text: "å¸Œæœ›å¯¹æ–¹èƒ½å­¦åˆ°ä¸œè¥¿ï¼Œä¸è¦é‡å¤çŠ¯é”™", animals: ["fox", "owl"] },
    { text: "ä¸æœŸå¾…ä»€ä¹ˆï¼Œå¸®åŠ©æœ¬èº«è®©æˆ‘å¼€å¿ƒ", animals: ["deer", "dolphin"] }
  ]}
];

const animals = {
  cat: { name: "çŒ«", icon: "ğŸ±", trait: "ç‹¬ç«‹è‡ªä¸»", color: "#a78bfa", desc: "ä½ æœ‰ç€çŒ«ä¸€æ ·çš„ç‹¬ç«‹æ€§æ ¼ï¼Œçè§†ä¸ªäººç©ºé—´å’Œè‡ªç”±ã€‚ä½ ä¸è½»æ˜“ä¾èµ–ä»–äººï¼Œæœ‰è‡ªå·±çš„èŠ‚å¥å’Œè¾¹ç•Œã€‚è¡¨é¢å¯èƒ½æ˜¾å¾—ç–ç¦»ï¼Œä½†å¯¹äº²è¿‘çš„äººæœ‰ç€æ·±åšçš„æ„Ÿæƒ…ã€‚ä½ éœ€è¦ç‹¬å¤„æ¥æ¢å¤èƒ½é‡ï¼Œè¢«æ‰“æ‰°ä¼šè®©ä½ çƒ¦èºã€‚" },
  dog: { name: "ç‹—", icon: "ğŸ•", trait: "å¿ è¯šçƒ­æƒ…", color: "#f59e0b", desc: "ä½ åƒç‹—ä¸€æ ·çƒ­æƒ…å¿ è¯šï¼Œæ¸´æœ›è¢«éœ€è¦å’Œè¢«çˆ±ã€‚ä½ å¯¹äº²è¿‘çš„äººå…¨å¿ƒä»˜å‡ºï¼Œå–œæ¬¢è¢«è®¤å¯å’Œè¡¨æ‰¬ã€‚ä½ å®³æ€•è¢«æŠ›å¼ƒæˆ–å¿½è§†ï¼Œæœ‰æ—¶ä¼šè¿‡åº¦è®¨å¥½ä»–äººã€‚ä½ çš„ä¸–ç•Œéœ€è¦ç¨³å®šçš„æƒ…æ„Ÿè¿æ¥ã€‚" },
  wolf: { name: "ç‹¼", icon: "ğŸº", trait: "å¼ºåŠ¿ä¿æŠ¤", color: "#6366f1", desc: "ä½ æœ‰ç‹¼çš„é¢†åœ°æ„è¯†å’Œä¿æŠ¤æ¬²ï¼Œåœ¨é¢å¯¹å¨èƒæ—¶ä¼šå±•ç°å¼ºåŠ¿çš„ä¸€é¢ã€‚ä½ é‡è§†å¿ è¯šå’ŒåŸåˆ™ï¼Œå¯¹è‡ªå·±äººæ— æ¡ä»¶ä¿æŠ¤ï¼Œå¯¹å¤–äººä¿æŒè­¦æƒ•ã€‚ä½ å¯èƒ½ä¸å–„è¨€è¾ï¼Œä½†è¡ŒåŠ¨åŠ›å¼ºï¼Œæ˜¯å¯é çš„å­˜åœ¨ã€‚" },
  fox: { name: "ç‹ç‹¸", icon: "ğŸ¦Š", trait: "æœºæ•çµæ´»", color: "#ec4899", desc: "ä½ åƒç‹ç‹¸ä¸€æ ·æœºæ•çµæ´»ï¼Œå–„äºè§‚å¯Ÿå’Œåº”å˜ã€‚ä½ ä¸ä¼šæ­£é¢ç¡¬åˆšï¼Œè€Œæ˜¯ç”¨æ™ºæ…§æ‰¾åˆ°æœ€ä¼˜è§£ã€‚ä½ æœ‰æ—¶ä¼šéšè—çœŸå®æƒ³æ³•ï¼Œè®©äººè§‰å¾—éš¾ä»¥æ‰æ‘¸ã€‚ä½ äº«å—æ™ºåŠ›æ¸¸æˆï¼Œä¸å–œæ¬¢è¢«çœ‹é€ã€‚" },
  deer: { name: "é¹¿", icon: "ğŸ¦Œ", trait: "æ•æ„Ÿæ¸©æŸ”", color: "#10b981", desc: "ä½ æœ‰ç€é¹¿ä¸€æ ·çš„æ•æ„Ÿå’Œæ¸©æŸ”ï¼Œèƒ½æ•é”æ„ŸçŸ¥ä»–äººçš„æƒ…ç»ªã€‚ä½ å¤©æ€§å–„è‰¯ï¼Œå®¹æ˜“å¿ƒè½¯ï¼Œæœ‰æ—¶ä¼šå› ä¸ºå¤ªåœ¨æ„åˆ«äººè€Œå¿½ç•¥è‡ªå·±ã€‚ä½ éœ€è¦å®‰å…¨çš„ç¯å¢ƒæ‰èƒ½æ”¾æ¾ï¼Œå®¹æ˜“å—æƒŠæˆ–å—ä¼¤ã€‚" },
  bear: { name: "ç†Š", icon: "ğŸ»", trait: "åŠ›é‡æ‹…å½“", color: "#8b5cf6", desc: "ä½ åƒç†Šä¸€æ ·æœ‰åŠ›é‡æ„Ÿå’Œæ‹…å½“ï¼Œå¹³æ—¶çœ‹èµ·æ¥æ¸©å’Œæ†¨åšï¼Œä½†åœ¨ä¿æŠ¤é‡è¦çš„äººæ—¶ä¼šçˆ†å‘å‡ºå¼ºå¤§çš„èƒ½é‡ã€‚ä½ å–œæ¬¢ç…§é¡¾äººï¼Œæœ‰æ—¶ä¼šè¿‡åº¦ä¿æŠ¤ã€‚ä½ éœ€è¦è¢«ä¿¡ä»»å’Œä¾èµ–çš„æ„Ÿè§‰ã€‚" },
  owl: { name: "çŒ«å¤´é¹°", icon: "ğŸ¦‰", trait: "æ™ºæ…§æ´å¯Ÿ", color: "#64748b", desc: "ä½ æœ‰ç€çŒ«å¤´é¹°èˆ¬çš„æ´å¯ŸåŠ›å’Œæ™ºæ…§ï¼Œå–œæ¬¢è§‚å¯Ÿå’Œæ€è€ƒã€‚ä½ ä¸è½»æ˜“è¡¨æ€ï¼Œä½†ä¸€æ—¦å‘è¨€å°±å¾ˆæœ‰åˆ†é‡ã€‚ä½ å¯èƒ½æ˜¾å¾—ç–ç¦»æˆ–é«˜å†·ï¼Œå®é™…ä¸Šåªæ˜¯åœ¨ç”¨è‡ªå·±çš„æ–¹å¼ç†è§£ä¸–ç•Œã€‚ä½ é‡è§†çŸ¥è¯†å’Œç†æ€§ã€‚" },
  dolphin: { name: "æµ·è±š", icon: "ğŸ¬", trait: "å…±æƒ…æ²»æ„ˆ", color: "#06b6d4", desc: "ä½ åƒæµ·è±šä¸€æ ·å…·æœ‰å¼ºå¤§çš„å…±æƒ…èƒ½åŠ›ï¼Œèƒ½æ„ŸçŸ¥å’Œæ²»æ„ˆä»–äººçš„æƒ…ç»ªã€‚ä½ ä¹äºåŠ©äººï¼Œå–œæ¬¢å’Œè°çš„æ°›å›´ï¼Œä¼šä¸»åŠ¨è°ƒè§£å†²çªã€‚ä½ æœ‰æ—¶ä¼šå› ä¸ºè¿‡åº¦å…±æƒ…è€Œæ¶ˆè€—è‡ªå·±ï¼Œéœ€è¦å­¦ä¼šä¿æŠ¤è‡ªå·±çš„èƒ½é‡ã€‚" }
};

const situations = {
  relax: { name: "æ”¾æ¾å®‰å…¨æ—¶", icon: "ğŸŒ¿", color: "#10b981", bg: "#d1fae5" },
  intimate: { name: "äº²å¯†å…³ç³»ä¸­", icon: "ğŸ’•", color: "#ec4899", bg: "#fce7f3" },
  conflict: { name: "å†²çªå‹åŠ›ä¸‹", icon: "âš¡", color: "#f59e0b", bg: "#fef3c7" },
  expected: { name: "è¢«éœ€è¦æ—¶", icon: "ğŸŒŸ", color: "#8b5cf6", bg: "#ede9fe" }
};

let idx = 0;
let answers = new Array(16).fill(null);

function render() {
  const q = questions[idx];

  document.getElementById('qNum').textContent = idx + 1;
  document.getElementById('current').textContent = idx + 1;
  document.getElementById('progressFill').style.width = `${((idx + 1) / questions.length) * 100}%`;
  document.getElementById('questionText').textContent = q.q;

  const container = document.getElementById('optionsContainer');
  container.innerHTML = q.options.map((opt, i) => `
    <div class="opt ${answers[idx] === i ? 'selected' : ''}" onclick="select(${i})">
      <div class="opt-radio"></div>
      <div class="opt-text">${opt.text}</div>
    </div>
  `).join('');

  document.getElementById('prevBtn').disabled = idx === 0;
  document.getElementById('nextBtn').innerHTML = idx === questions.length - 1 ?
    'æŸ¥çœ‹ç»“æœ <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>' :
    'ä¸‹ä¸€é¢˜ <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
  document.getElementById('nextBtn').disabled = answers[idx] === null;
}

function select(i) {
  answers[idx] = i;
  render();
}

function prev() {
  if (idx > 0) { idx--; render(); }
}

function next() {
  if (answers[idx] === null) return;
  if (idx < questions.length - 1) { idx++; render(); }
  else { showResult(); }
}

function calcScores() {
  const scores = {};
  const situationScores = { relax: {}, intimate: {}, conflict: {}, expected: {} };

  Object.keys(animals).forEach(a => {
    scores[a] = 0;
    Object.keys(situations).forEach(s => situationScores[s][a] = 0);
  });

  answers.forEach((ansIdx, qIdx) => {
    if (ansIdx === null) return;
    const q = questions[qIdx];
    const selectedAnimals = q.options[ansIdx].animals;
    selectedAnimals.forEach((a, i) => {
      const points = i === 0 ? 2 : 1;
      scores[a] += points;
      situationScores[q.situation][a] += points;
    });
  });

  return { total: scores, bySituation: situationScores };
}

function getTopAnimals(scores, count = 2) {
  return Object.entries(scores)
    .sort((a, b) => b[1] - a[1])
    .slice(0, count)
    .map(([animal]) => animal);
}

function getSituationAnimal(situationScores) {
  const result = {};
  Object.entries(situationScores).forEach(([sit, scores]) => {
    const top = getTopAnimals(scores, 1)[0];
    result[sit] = top;
  });
  return result;
}

function analyzeSwitchPattern(situationAnimals) {
  const uniqueAnimals = new Set(Object.values(situationAnimals));
  const switchCount = uniqueAnimals.size;

  if (switchCount === 1) {
    return { type: "ä¸€è‡´å‹", desc: "ä½ åœ¨ä¸åŒæƒ…å¢ƒä¸‹å±•ç°çš„äººæ ¼æ¨¡å¼éå¸¸ä¸€è‡´ï¼Œè¿™æ„å‘³ç€ä½ æœ‰ç€ç¨³å®šçš„æ ¸å¿ƒè‡ªæˆ‘ã€‚ä½ ä¸ä¼šå› ä¸ºç¯å¢ƒæ”¹å˜è€Œå¤§å¹…æ”¹å˜è‡ªå·±çš„åº”å¯¹æ–¹å¼ï¼Œè¿™æ˜¯ä¸€ç§å†…åœ¨ç¨³å®šçš„è¡¨ç°ã€‚ä½†ä¹Ÿè¦æ³¨æ„ï¼Œè¿‡äºä¸€è‡´å¯èƒ½æ„å‘³ç€åº”å¯¹ç­–ç•¥ä¸å¤Ÿçµæ´»ï¼ŒæŸäº›æƒ…å¢ƒä¸‹å¯èƒ½éœ€è¦æ›´å¤šé€‚åº”æ€§ã€‚" };
  } else if (switchCount === 2) {
    return { type: "åŒæ¨¡å¼åˆ‡æ¢", desc: "ä½ ä¸»è¦åœ¨ä¸¤ç§äººæ ¼æ¨¡å¼ä¹‹é—´åˆ‡æ¢ï¼Œè¿™æ˜¯ä¸€ç§å¥åº·çš„é€‚åº”æ¨¡å¼ã€‚ä½ èƒ½æ ¹æ®æƒ…å¢ƒéœ€è¦è°ƒæ•´è‡ªå·±çš„çŠ¶æ€ï¼ŒåŒæ—¶åˆä¿æŒäº†ä¸€å®šçš„ç¨³å®šæ€§ã€‚è¿™ç§åˆ‡æ¢é€šå¸¸æ˜¯è‡ªåŠ¨çš„ã€æµç•…çš„ï¼Œè¯´æ˜ä½ æœ‰ç€è‰¯å¥½çš„æƒ…å¢ƒé€‚åº”èƒ½åŠ›ã€‚" };
  } else if (switchCount === 3) {
    return { type: "å¤šæ¨¡å¼é€‚åº”", desc: "ä½ åœ¨ä¸åŒæƒ…å¢ƒä¸‹ä¼šå±•ç°å‡ºå¤šç§äººæ ¼æ¨¡å¼ï¼Œè¿™æ˜¾ç¤ºå‡ºä½ è¾ƒå¼ºçš„é€‚åº”èƒ½åŠ›å’Œçµæ´»æ€§ã€‚ä½ èƒ½å¤Ÿæ ¹æ®ä¸åŒçš„ç¤¾äº¤éœ€æ±‚è°ƒæ•´è‡ªå·±çš„çŠ¶æ€ï¼Œè¿™æ˜¯ä¸€ç§ç¤¾äº¤æ™ºæ…§çš„ä½“ç°ã€‚ä½†ä¹Ÿè¦æ³¨æ„ï¼Œè¿‡å¤šçš„åˆ‡æ¢å¯èƒ½ä¼šæ¶ˆè€—æ›´å¤šå¿ƒç†èƒ½é‡ï¼Œæ³¨æ„æ‰¾åˆ°è‡ªå·±çš„æ ¸å¿ƒçŠ¶æ€ã€‚" };
  } else {
    return { type: "é«˜åº¦é€‚åº”å‹", desc: "ä½ åœ¨æ¯ç§æƒ…å¢ƒä¸‹éƒ½ä¼šå±•ç°ä¸åŒçš„äººæ ¼æ¨¡å¼ï¼Œè¿™æ˜¾ç¤ºå‡ºæå¼ºçš„æƒ…å¢ƒé€‚åº”èƒ½åŠ›ã€‚ä½ å¾ˆå–„äºè¯»å–ç¯å¢ƒä¿¡å·å¹¶åšå‡ºç›¸åº”è°ƒæ•´ï¼Œè¿™è®©ä½ åœ¨å„ç§ç¤¾äº¤åœºåˆéƒ½èƒ½æ¸¸åˆƒæœ‰ä½™ã€‚ä½†ä¹Ÿéœ€è¦è­¦æƒ•ï¼šå¦‚æœåˆ‡æ¢è¿‡äºé¢‘ç¹æˆ–åˆ»æ„ï¼Œå¯èƒ½ä¼šå¯¼è‡´ã€Œæˆ‘åˆ°åº•æ˜¯è°ã€çš„å›°æƒ‘ï¼Œå»ºè®®å¤šèŠ±æ—¶é—´ç‹¬å¤„ï¼Œè¿æ¥çœŸå®çš„è‡ªå·±ã€‚" };
  }
}

function getEnergyDrain(situationAnimals) {
  const conflictAnimal = situationAnimals.conflict;
  const relaxAnimal = situationAnimals.relax;

  if (conflictAnimal === relaxAnimal) {
    return "ä½ åœ¨å‹åŠ›ä¸‹å’Œæ”¾æ¾æ—¶çš„çŠ¶æ€æ¯”è¾ƒä¸€è‡´ï¼Œè¯´æ˜å†²çªå¯¹ä½ çš„æ¶ˆè€—ç›¸å¯¹è¾ƒå°ã€‚ä½ èƒ½ç”¨ç›¸å¯¹è‡ªç„¶çš„æ–¹å¼åº”å¯¹å‹åŠ›ã€‚";
  }

  const drainMap = {
    "deer": "å†²çªæƒ…å¢ƒå¯¹ä½ çš„æ¶ˆè€—æœ€å¤§ã€‚ä½ å¤©æ€§æ•æ„Ÿæ¸©æŸ”ï¼Œæ¿€çƒˆçš„å¯¹æŠ—ä¼šè®©ä½ æ„Ÿåˆ°å·¨å¤§çš„å†…è€—ã€‚å»ºè®®åœ¨å†²çªåç»™è‡ªå·±è¶³å¤Ÿçš„æ¢å¤æ—¶é—´ï¼Œé¿å…è¿ç»­é¢å¯¹é«˜å‹åœºæ™¯ã€‚",
    "dolphin": "éœ€è¦æ‰¿å—ä»–äººè´Ÿé¢æƒ…ç»ªçš„æƒ…å¢ƒå¯¹ä½ æ¶ˆè€—æœ€å¤§ã€‚ä½ çš„å…±æƒ…èƒ½åŠ›è®©ä½ å¾ˆå®¹æ˜“å¸æ”¶ä»–äººçš„æƒ…ç»ªï¼Œå»ºè®®å­¦ä¹ å»ºç«‹æƒ…ç»ªè¾¹ç•Œã€‚",
    "dog": "è¢«æ‹’ç»æˆ–è¢«å¿½è§†çš„æƒ…å¢ƒå¯¹ä½ æ¶ˆè€—æœ€å¤§ã€‚ä½ æ¸´æœ›è¢«éœ€è¦å’Œè¢«è®¤å¯ï¼Œå½“è¿™ç§éœ€æ±‚æ— æ³•æ»¡è¶³æ—¶ä¼šæ„Ÿåˆ°å·¨å¤§çš„å¤±è½ã€‚",
    "cat": "è¢«è¿«ç¤¾äº¤æˆ–å¤±å»ä¸ªäººç©ºé—´çš„æƒ…å¢ƒå¯¹ä½ æ¶ˆè€—æœ€å¤§ã€‚ä½ éœ€è¦ç‹¬å¤„æ¥æ¢å¤èƒ½é‡ï¼Œå»ºè®®ä¸ºè‡ªå·±äº‰å–è¶³å¤Ÿçš„ç‹¬å¤„æ—¶é—´ã€‚",
    "wolf": "æ— æ³•æŒæ§å±€é¢çš„æƒ…å¢ƒå¯¹ä½ æ¶ˆè€—æœ€å¤§ã€‚ä½ ä¹ æƒ¯äºä¸»å¯¼ï¼Œå½“å¤±å»æ§åˆ¶æ„Ÿæ—¶ä¼šæ„Ÿåˆ°ç„¦è™‘ã€‚",
    "bear": "æ— æ³•ä¿æŠ¤é‡è¦çš„äººçš„æƒ…å¢ƒå¯¹ä½ æ¶ˆè€—æœ€å¤§ã€‚ä½ çš„ä¿æŠ¤æ¬²å¾ˆå¼ºï¼Œå½“æ„Ÿåˆ°æ— åŠ›ä¿æŠ¤æ—¶ä¼šäº§ç”Ÿè‡ªè´£ã€‚",
    "fox": "è¢«çœ‹é€æˆ–è¢«é™åˆ¶çš„æƒ…å¢ƒå¯¹ä½ æ¶ˆè€—æœ€å¤§ã€‚ä½ å–œæ¬¢ä¿æŒç¥ç§˜æ„Ÿå’Œçµæ´»æ€§ï¼Œè¢«çº¦æŸä¼šè®©ä½ ä¸é€‚ã€‚",
    "owl": "è¢«è¿«å¿«é€Ÿå†³ç­–æˆ–æƒ…ç»ªåŒ–åœºæ™¯å¯¹ä½ æ¶ˆè€—æœ€å¤§ã€‚ä½ éœ€è¦æ—¶é—´æ€è€ƒå’Œè§‚å¯Ÿï¼Œè¢«å‚¬ä¿ƒä¼šè®©ä½ å¤±å»å¹³è¡¡ã€‚"
  };

  return drainMap[conflictAnimal] || "æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„èƒ½é‡æ¶ˆè€—æ¨¡å¼ï¼Œå»ºè®®è§‚å¯Ÿä»€ä¹ˆæƒ…å¢ƒè®©ä½ æœ€ç–²æƒ«ï¼Œå¹¶ä¸»åŠ¨è°ƒæ•´ã€‚";
}

function goToHome() { window.location.href = '../platform.html'; }

function getHomeButtonHtml() {
  const userSource = sessionStorage.getItem('user_source');
  if (userSource === 'platform') {
    return '<button class="restart-btn" onclick="goToHome()" style="margin-left:8px">è¿”å›æµ‹è¯•ä¸­å¿ƒ</button>';
  } else {
    return '<button class="restart-btn more-tests-btn" onclick="showMoreTests()" style="margin-left:8px">æ›´å¤šæµ‹è¯•</button>';
  }
}

function showMoreTests() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `<div class="modal-content"><div class="modal-icon">ğŸ§‚</div><h3>æ›´å¤šä¸“ä¸šæµ‹è¯„</h3><p>è¯·åœ¨å®‡å®™è®¤çŸ¥ç›ç©¶æ‰€è´­ä¹°å…¶ä»–æµ‹è¯•å“¦~</p><div class="modal-buttons"><button class="modal-btn primary" onclick="closeModal()">çŸ¥é“äº†</button></div></div>`;
  document.body.appendChild(modal);
  setTimeout(() => modal.classList.add('show'), 10);
}

function closeModal() {
  const modal = document.querySelector('.modal-overlay');
  if (modal) { modal.classList.remove('show'); setTimeout(() => modal.remove(), 300); }
}

function showResult() {
  document.getElementById('testPage').classList.remove('active');
  document.getElementById('resultPage').classList.add('active');

  const { total, bySituation } = calcScores();
  const topAnimals = getTopAnimals(total, 2);
  const mainAnimal = animals[topAnimals[0]];
  const subAnimal = animals[topAnimals[1]];
  const situationAnimals = getSituationAnimal(bySituation);
  const switchPattern = analyzeSwitchPattern(situationAnimals);
  const energyDrain = getEnergyDrain(situationAnimals);

  document.getElementById('resultContent').innerHTML = `
    <div class="result-header">
      <div class="result-logo">${mainAnimal.icon}</div>
      <h1 class="result-title">ä½ çš„åŠ¨ç‰©äººæ ¼ï¼š${mainAnimal.name}</h1>
      <p class="result-subtitle">åœ¨ä¸åŒæƒ…å¢ƒä¸‹ï¼Œä½ ä¼šå±•ç°ä¸åŒçš„åŠ¨ç‰©äººæ ¼é¢å‘</p>
    </div>

    <div class="card">
      <div class="section-title"><div class="section-icon" style="background:#fef3c7">ğŸ­</div>ä¸»å¯¼åŠ¨ç‰©äººæ ¼</div>
      <div class="animal-main">
        <div class="animal-icon">${mainAnimal.icon}</div>
        <div class="animal-info">
          <h3>${mainAnimal.name}å‹äººæ ¼</h3>
          <div class="subtitle">${mainAnimal.trait}</div>
          <p>${mainAnimal.desc}</p>
        </div>
      </div>

      <div class="section-title" style="margin-top:24px"><div class="section-icon" style="background:#ede9fe">ğŸŒ™</div>æ¬¡çº§é˜²å¾¡åŠ¨ç‰©</div>
      <div class="animal-secondary">
        <div class="animal-card">
          <div class="icon">${subAnimal.icon}</div>
          <div class="name">${subAnimal.name}å‹</div>
          <div class="context">${subAnimal.trait}</div>
          <div class="desc">åœ¨å‹åŠ›æˆ–ç‰¹å®šæƒ…å¢ƒä¸‹ï¼Œä½ ä¼šåˆ‡æ¢åˆ°${subAnimal.name}æ¨¡å¼ä½œä¸ºé˜²å¾¡æˆ–é€‚åº”</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><div class="section-icon" style="background:#dbeafe">ğŸ”„</div>æƒ…å¢ƒäººæ ¼åˆ‡æ¢</div>
      <div class="situation-analysis">
        ${Object.entries(situationAnimals).map(([sit, animal]) => {
          const sitInfo = situations[sit];
          const animalInfo = animals[animal];
          return `
            <div class="situation-item">
              <div class="situation-header">
                <div class="situation-icon" style="background:${sitInfo.bg};color:${sitInfo.color}">${sitInfo.icon}</div>
                <div>
                  <div class="situation-name">${sitInfo.name}</div>
                  <div class="situation-animal">${animalInfo.icon} ${animalInfo.name}å‹ Â· ${animalInfo.trait}</div>
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>

      <div class="switch-analysis">
        <div class="switch-title">ğŸ“Š åˆ‡æ¢æ¨¡å¼åˆ†æï¼š${switchPattern.type}</div>
        <div class="switch-content">${switchPattern.desc}</div>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><div class="section-icon" style="background:#fee2e2">âš¡</div>èƒ½é‡æ¶ˆè€—åˆ†æ</div>
      <p style="font-size:14px;color:var(--text-muted);line-height:1.7">${energyDrain}</p>
    </div>

    <div class="card">
      <div class="section-title"><div class="section-icon" style="background:#d1fae5">ğŸ’¡</div>äººæ ¼åˆ‡æ¢æ›´æŸ”æ€§çš„å»ºè®®</div>
      <div class="tip-item"><div class="tip-num">1</div><div class="tip-text">è§‰å¯Ÿä½ çš„è‡ªåŠ¨ååº”ï¼šä¸‹æ¬¡è¿›å…¥æŸä¸ªæƒ…å¢ƒæ—¶ï¼Œè§‚å¯Ÿè‡ªå·±æ˜¯å¦‚ä½•è‡ªåŠ¨åˆ‡æ¢çš„</div></div>
      <div class="tip-item"><div class="tip-num">2</div><div class="tip-text">ç»™åˆ‡æ¢ç•™å‡ºç¼“å†²ï¼šä¸è¦åœ¨ä¸åŒæƒ…å¢ƒé—´å¿«é€Ÿåˆ‡æ¢ï¼Œç»™è‡ªå·±å‡ åˆ†é’Ÿè¿‡æ¸¡æ—¶é—´</div></div>
      <div class="tip-item"><div class="tip-num">3</div><div class="tip-text">åœ¨å®‰å…¨ç¯å¢ƒç»ƒä¹ ï¼šå°è¯•åœ¨æ”¾æ¾æ—¶ç”¨ä¸åŒçš„æ–¹å¼å›åº”ï¼Œæ‰©å±•ä½ çš„ååº”æ¨¡å¼</div></div>
      <div class="tip-item"><div class="tip-num">4</div><div class="tip-text">æ¥çº³æ¯ä¸ªé¢å‘ï¼šæ¯ç§åŠ¨ç‰©äººæ ¼éƒ½æœ‰å…¶ä»·å€¼ï¼Œä¸è¦å¦å®šä»»ä½•ä¸€ä¸ªéƒ¨åˆ†çš„è‡ªå·±</div></div>
    </div>

    <div class="card" style="text-align:center;background:linear-gradient(135deg,#fef3c7 0%,#fff7ed 100%)">
      <p style="font-size:15px;color:#92400e;line-height:1.8">
        ä½ ä¸éœ€è¦åªæ˜¯ä¸€ç§åŠ¨ç‰©<br>
        åœ¨ä¸åŒçš„æ£®æ—é‡Œï¼Œä½ å¯ä»¥æ˜¯ä¸åŒçš„å­˜åœ¨<br>
        é‡è¦çš„æ˜¯ï¼ŒçŸ¥é“è‡ªå·±ä¸ºä»€ä¹ˆä¼šå˜ï¼Œä»¥åŠå¦‚ä½•æ›´è‡ªåœ¨åœ°å˜
      </p>
    </div>

    <div class="action-buttons">
      <button class="action-btn primary" onclick="downloadPDF()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        ä¸‹è½½PDFæŠ¥å‘Š
      </button>
      <button class="restart-btn" onclick="location.reload()">é‡æ–°æµ‹è¯•</button>
      ${getHomeButtonHtml()}
    </div>

    <div style="text-align:center;margin-top:32px;padding-top:24px;border-top:1px solid var(--border)">
      <p style="font-size:12px;color:var(--text-muted)">Â© 2025 å®‡å®™è®¤çŸ¥ç›ç©¶æ‰€ Â· æµ‹è¯„ç»“æœä»…ä¾›å‚è€ƒ</p>
    </div>
  `;
}

async function downloadPDF() {
  const btn = document.querySelector('.action-btn.primary');
  const loading = document.getElementById('loading');
  btn.disabled = true;
  btn.innerHTML = 'ç”Ÿæˆä¸­...';
  loading.classList.add('show');

  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const content = document.getElementById('resultContent');
    const canvas = await html2canvas(content, { scale: 2, useCORS: true, backgroundColor: '#f8fafc' });
    const imgData = canvas.toDataURL('image/jpeg', 0.95);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = canvas.width;
    const imgHeight = canvas.height;
    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
    const imgX = (pdfWidth - imgWidth * ratio) / 2;
    let imgY = 0;
    let heightLeft = imgHeight * ratio;

    pdf.addImage(imgData, 'JPEG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
    heightLeft -= pdfHeight;

    while (heightLeft > 0) {
      imgY = heightLeft - imgHeight * ratio;
      pdf.addPage();
      pdf.addImage(imgData, 'JPEG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
      heightLeft -= pdfHeight;
    }

    const date = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');
    pdf.save(`åŠ¨ç‰©æŠ•å°„æµ‹è¯•æŠ¥å‘Š_${date}.pdf`);
  } catch (e) { console.error(e); alert('PDFç”Ÿæˆå¤±è´¥'); }
  finally {
    btn.disabled = false;
    btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> ä¸‹è½½PDFæŠ¥å‘Š';
    loading.classList.remove('show');
  }
}

render();
</script>
</body>
</html>
